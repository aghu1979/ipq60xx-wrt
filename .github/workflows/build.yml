# .github/workflows/build.yml
name: Reusable OpenWrt Build Workflow

on:
  workflow_call:
    inputs:
      branch_config:
        required: true
        type: string
        description: 'åˆ†æ”¯é…ç½®åï¼Œå¦‚ openwrt_base'
      package_config:
        required: true
        type: string
        description: 'è½¯ä»¶åŒ…é…ç½®åï¼Œå¦‚ Pro'
      target_arch:
        required: true
        type: string
        default: 'ipq60xx'
        description: 'ç›®æ ‡èŠ¯ç‰‡æž¶æž„'
      ubuntu_version:
        description: 'é€‰æ‹©è¿è¡ŒçŽ¯å¢ƒæ“ä½œç³»ç»Ÿç‰ˆæœ¬'
        required: true
        type: string
        default: 'ubuntu-22.04'

jobs:
  build:
    runs-on: ${{ inputs.ubuntu_version }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç¼“å­˜ OpenWrt æºç 
        id: cache-source
        uses: actions/cache@v4
        with:
          path: openwrt
          key: ${{ runner.os }}-${{ inputs.branch_config }}-source-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ inputs.branch_config }}-source-

      - name: å…‹éš†æºç 
        if: steps.cache-source.outputs.cache-hit != 'true'
        run: |
          if [ "${{ inputs.branch_config }}" == "immwrt_base" ]; then
            REPO_URL="https://github.com/laipeng668/immortalwrt.git"
            REPO_BRANCH="master"
          elif [ "${{ inputs.branch_config }}" == "libwrt_base" ]; then
            REPO_URL="https://github.com/laipeng668/openwrt-6.x.git"
            REPO_BRANCH="k6.12-nss"
          else
            REPO_URL="https://github.com/laipeng668/openwrt.git"
            REPO_BRANCH="master"
          fi
          echo "æ­£åœ¨ä»Ž $REPO_URL (åˆ†æ”¯: $REPO_BRANCH) å…‹éš†æºç åˆ° openwrt/ ç›®å½•"
          git clone $REPO_URL -b $REPO_BRANCH openwrt

      # ã€å…³é”®ä¿®æ”¹ã€‘ä¼˜åŒ–ç¼“å­˜é”®ï¼Œä½¿å…¶åªä¾èµ–äºŽ feeds.conf.defaultï¼Œç¡®ä¿åŒåˆ†æ”¯å…±äº«ç¼“å­˜
      - name: ç¼“å­˜ Feeds å’Œä¸‹è½½åŒ…
        id: cache-feeds-dl
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/feeds
          key: ${{ runner.os }}-${{ inputs.branch_config }}-feeds-dl-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-${{ inputs.branch_config }}-feeds-dl-
        if: success()

      - name: Ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ inputs.target_arch }}-${{ inputs.branch_config }}
          max-size: 5G

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          echo "::group::Installing System Dependencies on ${{ inputs.ubuntu_version }}"
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext libelf-dev libssl-dev \
          libncurses5-dev libncursesw5-dev python3-pyelftools \
          python3-setuptools rsync swig unzip wget python3-pip ccache
          echo "::endgroup::"

      - name: æ›´æ–°å’Œå®‰è£… Feeds
        if: steps.cache-feeds-dl.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          cd openwrt
          echo "ðŸ”§ æ­£åœ¨åˆå¹¶é…ç½®: åˆ†æ”¯-${{ inputs.branch_config }}, è½¯ä»¶-${{ inputs.package_config }}, æž¶æž„-${{ inputs.target_arch }}"
          cat ../configs/base/${{ inputs.target_arch }}_base.config \
              ../configs/branch/${{ inputs.branch_config }}.config \
              ../configs/packages/${{ inputs.package_config }}.config > .config
          echo "âœ… é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆã€‚"

      - name: è¿è¡Œè‡ªå®šä¹‰DIYè„šæœ¬
        run: |
          cd openwrt
          chmod +x $GITHUB_WORKSPACE/scripts/diy.sh
          $GITHUB_WORKSPACE/scripts/diy.sh ${{ inputs.branch_config }} ${{ inputs.target_arch }}

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          echo "ðŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          make -j$(nproc) || (echo "âŒ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œæ­£åœ¨å°è¯•å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘..." && make -j1 V=s)

      - name: æ”¶é›†å›ºä»¶äº§ç‰©
        run: |
          cd openwrt
          mkdir -p ../firmware
          find bin/targets/ -type f \( -name "*sysupgrade*" -o -name "*factory*" \) -exec cp {} ../firmware/ \;
          echo "âœ… å›ºä»¶äº§ç‰©å·²æ”¶é›†ã€‚"
          ls -lh ../firmware/

      - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ inputs.target_arch }}-${{ inputs.branch_config }}-${{ inputs.package_config }}
          path: ./firmware/

      - name: ä¸Šä¼ é”™è¯¯æ—¥å¿— (ä»…åœ¨å¤±è´¥æ—¶)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ inputs.branch_config }}-${{ inputs.package_config }}
          path: |
            openwrt/build.log
            openwrt/.config

      - name: ç”Ÿæˆæž„å»ºæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“¦ OpenWrt æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "### åˆ†æ”¯: ${{ inputs.branch_config }} | è½¯ä»¶: ${{ inputs.package_config }} | æž¶æž„: ${{ inputs.target_arch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç›®æ ‡æ–‡ä»¶ | å¤§å° | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "./firmware" ] && [ "$(ls -A ./firmware)" ]; then
            for file in ./firmware/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                filesize=$(stat -c%s "$file" | awk '{printf "%.2f MB", $1/1024/1024}')
                sha256=$(sha256sum "$file" | awk '{print $1}')
                echo "| $filename | $filesize | \`$sha256\` |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "| æœªç”Ÿæˆå›ºä»¶æ–‡ä»¶ | - | - |" >> $GITHUB_STEP_SUMMARY
          fi

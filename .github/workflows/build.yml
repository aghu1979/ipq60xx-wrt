# .github/workflows/build.yml
name: Reusable OpenWrt Build Workflow

on:
  workflow_call:
    inputs:
      branch_config:
        required: true
        type: string
        description: 'åˆ†æ”¯é…ç½®åï¼Œå¦‚ base_openwrt'
      package_config:
        required: true
        type: string
        description: 'è½¯ä»¶åŒ…é…ç½®åï¼Œå¦‚ Pro'
      target_arch:
        required: true
        type: string
        default: 'ipq60xx'
        description: 'ç›®æ ‡èŠ¯ç‰‡æ¶æ„'
      ubuntu_version:
        description: 'é€‰æ‹©è¿è¡Œç¯å¢ƒæ“ä½œç³»ç»Ÿç‰ˆæœ¬'
        required: true
        type: string
        default: 'ubuntu-22.04'

jobs:
  build:
    runs-on: ${{ inputs.ubuntu_version }}

    # å®šä¹‰å½©è‰²è¾“å‡ºå˜é‡
    env:
      GREEN: '\033[0;32m'
      YELLOW: '\033[1;33m'
      RED: '\033[0;31m'
      BLUE: '\033[0;34m'
      CYAN: '\033[0;36m'
      MAGENTA: '\033[0;35m'
      BOLD: '\033[1m'
      BG_RED: '\033[41m'
      NC: '\033[0m' # No Color

    steps:
      - name: ğŸš€ å‡†å¤‡å°±ç»ª
        run: echo -e "${GREEN}â–¶ï¸ å¼€å§‹æ‰§è¡Œ OpenWrt è‡ªåŠ¨åŒ–æ„å»ºæµç¨‹...${NC}"

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ’¾ ç¼“å­˜ OpenWrt æºç 
        id: cache-source
        uses: actions/cache@v4
        with:
          path: openwrt
          key: ${{ runner.os }}-${{ inputs.branch_config }}-source-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ inputs.branch_config }}-source-
      
      - name: ğŸ“¥ å…‹éš†æºç 
        if: steps.cache-source.outputs.cache-hit != 'true'
        run: |
          echo -e "${YELLOW}â¬‡ï¸ ç¼“å­˜æœªå‘½ä¸­ï¼Œæ­£åœ¨ä»è¿œç¨‹å…‹éš†æºç ...${NC}"
          if [ "${{ inputs.branch_config }}" == "base_immwrt" ]; then
            REPO_URL="https://github.com/laipeng668/immortalwrt.git"
            REPO_BRANCH="master"
          elif [ "${{ inputs.branch_config }}" == "base_libwrt" ]; then
            REPO_URL="https://github.com/laipeng668/openwrt-6.x.git"
            REPO_BRANCH="k6.12-nss"
          else
            REPO_URL="https://github.com/laipeng668/openwrt.git"
            REPO_BRANCH="master"
          fi
          echo "æ­£åœ¨ä» $REPO_URL (åˆ†æ”¯: $REPO_BRANCH) å…‹éš†æºç åˆ° openwrt/ ç›®å½•"
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          echo -e "${GREEN}âœ… æºç å…‹éš†å®Œæˆã€‚${NC}"

      - name: ğŸ’¾ ç¼“å­˜ Feeds å’Œä¸‹è½½åŒ…
        id: cache-feeds-dl
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/feeds
          key: ${{ runner.os }}-${{ inputs.branch_config }}-feeds-dl
          restore-keys: |
            ${{ runner.os }}-${{ inputs.branch_config }}-feeds-dl-
        if: success()

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          echo -e "${YELLOW}ğŸ”§ æ­£åœ¨å®‰è£…ç¼–è¯‘ä¾èµ–...${NC}"
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext libelf-dev libssl-dev \
          libncurses5-dev libncursesw5-dev python3-pyelftools \
          python3-setuptools rsync swig unzip wget python3-pip ccache
          echo -e "${GREEN}âœ… ç¼–è¯‘ä¾èµ–å®‰è£…å®Œæˆã€‚${NC}"

      - name: ğŸ”„ æ›´æ–°å’Œå®‰è£… Feeds
        if: steps.cache-feeds-dl.outputs.cache-hit != 'true'
        run: |
          echo -e "${YELLOW}ğŸ”„ ç¼“å­˜æœªå‘½ä¸­ï¼Œæ­£åœ¨æ›´æ–°å’Œå®‰è£… Feeds...${NC}"
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo -e "${GREEN}âœ… Feeds æ›´æ–°å’Œå®‰è£…å®Œæˆã€‚${NC}"
      
      - name: âœ… Feeds ç¼“å­˜å‘½ä¸­
        if: steps.cache-feeds-dl.outputs.cache-hit == 'true'
        run: |
          echo -e "${GREEN}âœ… Feeds å’Œä¸‹è½½åŒ…ç¼“å­˜å‘½ä¸­ï¼Œè·³è¿‡æ›´æ–°å’Œå®‰è£…æ­¥éª¤ã€‚${NC}"

      - name: ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          cd openwrt
          echo -e "${YELLOW}ğŸ”§ æ­£åœ¨åˆå¹¶é…ç½®: åˆ†æ”¯-${{ inputs.branch_config }}, è½¯ä»¶-${{ inputs.package_config }}, æ¶æ„-${{ inputs.target_arch }}${NC}"
          cat ../configs/base_${{ inputs.target_arch }}.config \
              ../configs/${{ inputs.branch_config }}.config \
              ../configs/${{ inputs.package_config }}.config > .config
          echo -e "${GREEN}âœ… é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆã€‚${NC}"
          # æ˜¾ç¤ºé…ç½®æ–‡ä»¶å†…å®¹
          echo "::group::ğŸ“„ æŸ¥çœ‹é…ç½®æ–‡ä»¶ .config æ–‡ä»¶å†…å®¹"
          cat .config
          echo "::endgroup::"

      - name: ğŸ§ª è¿è¡Œè‡ªå®šä¹‰DIYè„šæœ¬
        run: |
          cd openwrt
          echo -e "${YELLOW}ğŸ§ª æ­£åœ¨è¿è¡Œè‡ªå®šä¹‰DIYè„šæœ¬...${NC}"
          chmod +x $GITHUB_WORKSPACE/scripts/diy.sh
          $GITHUB_WORKSPACE/scripts/diy.sh ${{ inputs.branch_config }} ${{ inputs.target_arch }}
          echo -e "${GREEN}âœ… DIYè„šæœ¬æ‰§è¡Œå®Œæˆã€‚${NC}"

      - name: ğŸ§¹ æ ¼å¼åŒ–é…ç½®æ–‡ä»¶å¹¶åˆ†æå·®å¼‚
        run: |
          cd openwrt
          echo -e "${YELLOW}ğŸ§¹ æ­£åœ¨æ ¼å¼åŒ– .config æ–‡ä»¶ä»¥è§£å†³æ½œåœ¨çš„æ ¼å¼é—®é¢˜...${NC}"
          
          # ä¿å­˜æ ¼å¼åŒ–å‰çš„é…ç½®ï¼Œç”¨äºå¯¹æ¯”
          cp .config .config.pre-defconfig
          
          # æ‰§è¡Œæ ¼å¼åŒ–
          make defconfig
          echo -e "${GREEN}âœ… .config æ–‡ä»¶æ ¼å¼åŒ–å®Œæˆã€‚${NC}"

          # æ˜¾ç¤ºæ ¼å¼åŒ–åçš„æœ€ç»ˆé…ç½®æ–‡ä»¶å†…å®¹
          echo "::group::ğŸ“„ æŸ¥çœ‹æ ¼å¼åŒ–åçš„æœ€ç»ˆ .config æ–‡ä»¶å†…å®¹"
          cat .config
          echo "::endgroup::"
          
          # å¯¹æ¯”å¹¶æ˜¾ç¤º Luci è½¯ä»¶åŒ…çš„å·®å¼‚
          echo "::group::ğŸ” å¯¹æ¯”æ ¼å¼åŒ–å‰åçš„ Luci è½¯ä»¶åŒ…å·®å¼‚"
          echo "æ­£åœ¨åˆ†æ 'make defconfig' å¯¹ Luci è½¯ä»¶åŒ…çš„å½±å“..."
          
          # æ‰¾å‡ºæ ¼å¼åŒ–å‰æ‰€æœ‰å€¼ä¸ºyçš„luciè½¯ä»¶åŒ…
          echo -e "\n${YELLOW}ğŸ“‹ æ ¼å¼åŒ–å‰å¯ç”¨çš„ Luci è½¯ä»¶åŒ… (CONFIG_PACKAGE_luci*=y):${NC}"
          grep "CONFIG_PACKAGE_luci.*=y" .config.pre-defconfig | sort > /tmp/luci_enabled_before.txt
          cat /tmp/luci_enabled_before.txt
          
          # æ£€æŸ¥è¿™äº›è½¯ä»¶åŒ…åœ¨æ ¼å¼åŒ–åçš„çŠ¶æ€
          echo -e "\n${YELLOW}ğŸ“‹ æ£€æŸ¥è¿™äº›è½¯ä»¶åŒ…åœ¨æ ¼å¼åŒ–åçš„çŠ¶æ€:${NC}"
          echo -e "${CYAN}æ ¼å¼ | è½¯ä»¶åŒ…åç§° | æ ¼å¼åŒ–å‰çŠ¶æ€ | æ ¼å¼åŒ–åçŠ¶æ€ | å˜åŒ–${NC}"
          echo "------|------------|--------------|--------------|------"
          
          # ç»Ÿè®¡å˜é‡
          total_packages=0
          changed_packages=0
          removed_packages=0
          
          while IFS= read -r line; do
            pkg_name=$(echo "$line" | cut -d'=' -f1)
            before_status=$(echo "$line" | cut -d'=' -f2)
            total_packages=$((total_packages + 1))
            
            # æ£€æŸ¥æ ¼å¼åŒ–åçš„çŠ¶æ€
            after_line=$(grep "^$pkg_name=" .config)
            if [ -n "$after_line" ]; then
              after_status=$(echo "$after_line" | cut -d'=' -f2)
              if [ "$before_status" = "$after_status" ]; then
                change="æ— å˜åŒ–"
                echo -e "æ ¼å¼åŒ– | $pkg_name | $before_status | $after_status | $change"
              else
                changed_packages=$((changed_packages + 1))
                change="${RED}çŠ¶æ€æ”¹å˜${NC}"
                echo -e "æ ¼å¼åŒ– | ${BOLD}$pkg_name${NC} | $before_status | ${RED}$after_status${NC} | $change"
              fi
            else
              removed_packages=$((removed_packages + 1))
              after_status="${RED}æœªæ‰¾åˆ°${NC}"
              change="${BG_RED}å·²ç§»é™¤${NC}"
              echo -e "æ ¼å¼åŒ– | ${BOLD}$pkg_name${NC} | $before_status | $after_status | $change"
            fi
          done < /tmp/luci_enabled_before.txt
          
          # æ‰¾å‡ºæ ¼å¼åŒ–åæ–°å¢çš„luciè½¯ä»¶åŒ…
          echo -e "\n${YELLOW}ğŸ“‹ æ ¼å¼åŒ–åæ–°å¢çš„ Luci è½¯ä»¶åŒ…:${NC}"
          grep "CONFIG_PACKAGE_luci.*=y" .config | sort > /tmp/luci_enabled_after.txt
          new_packages=$(comm -13 <(sort /tmp/luci_enabled_before.txt) <(sort /tmp/luci_enabled_after.txt))
          if [ -n "$new_packages" ]; then
            echo -e "${GREEN}$new_packages${NC}"
          else
            echo -e "${CYAN}æ— æ–°å¢è½¯ä»¶åŒ…${NC}"
          fi
          
          # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
          echo -e "\n${MAGENTA}ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:${NC}"
          echo -e "æ€»è½¯ä»¶åŒ…æ•°: ${BOLD}$total_packages${NC}"
          echo -e "çŠ¶æ€æ”¹å˜: ${RED}$changed_packages${NC}"
          echo -e "å·²ç§»é™¤: ${RED}$removed_packages${NC}"
          echo -e "æ–°å¢è½¯ä»¶åŒ…: ${GREEN}$(echo "$new_packages" | grep -c . || echo 0)${NC}"
          
          # æ˜¾ç¤ºå®Œæ•´çš„å·®å¼‚å¯¹æ¯”ï¼Œé«˜äº®æ˜¾ç¤ºå·®å¼‚
          echo -e "\n${YELLOW}ğŸ“‹ å®Œæ•´çš„ Luci è½¯ä»¶åŒ…å·®å¼‚å¯¹æ¯”:${NC}"
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶è„šæœ¬æ¥å¤„ç†diffè¾“å‡ºå¹¶é«˜äº®å·®å¼‚
          cat > /tmp/highlight_diff.sh << 'EOF'
          #!/bin/bash
          while IFS= read -r line; do
            case "$line" in
              "<"*)
                echo -e "${RED}$line${NC}"
                ;;
              ">"*)
                echo -e "${GREEN}$line${NC}"
                ;;
              "---"*)
                echo -e "${CYAN}$line${NC}"
                ;;
              *)
                echo "$line"
                ;;
            esac
          done
          EOF
          chmod +x /tmp/highlight_diff.sh
          
          # ä½¿ç”¨diffå¹¶é«˜äº®æ˜¾ç¤ºå·®å¼‚
          diff <(grep "CONFIG_PACKAGE_luci" .config.pre-defconfig | sort) <(grep "CONFIG_PACKAGE_luci" .config | sort) | /tmp/highlight_diff.sh || echo -e "${CYAN}æ— å·®å¼‚${NC}"
          
          echo -e "\n${GREEN}âœ… Luci è½¯ä»¶åŒ…å¯¹æ¯”åˆ†æå®Œæˆã€‚${NC}"
          echo "::endgroup::"

      - name: ğŸ—ï¸ ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          echo -e "${YELLOW}ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶... (è¿™å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´)${NC}"
          make -j$(nproc) || (echo -e "${RED}âŒ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œæ­£åœ¨å°è¯•å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘...${NC}" && make -j1 V=s)
          echo -e "${GREEN}âœ… å›ºä»¶ç¼–è¯‘å®Œæˆã€‚${NC}"

      - name: ğŸ“¦ æ”¶é›†å›ºä»¶äº§ç‰©
        run: |
          cd openwrt
          mkdir -p ../firmware
          find bin/targets/ -type f \( -name "*sysupgrade*" -o -name "*factory*" \) -exec cp {} ../firmware/ \;
          echo -e "${GREEN}âœ… å›ºä»¶äº§ç‰©å·²æ”¶é›†ã€‚${NC}"
          ls -lh ../firmware/

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ inputs.target_arch }}-${{ inputs.branch_config }}-${{ inputs.package_config }}
          path: ./firmware/

      - name: ğŸ“¤ ä¸Šä¼ é”™è¯¯æ—¥å¿— (ä»…åœ¨å¤±è´¥æ—¶)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ inputs.branch_config }}-${{ inputs.package_config }}
          path: |
            openwrt/build.log
            openwrt/.config

      - name: ğŸ“‹ ç”Ÿæˆæ„å»ºæ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ“¦ OpenWrt æ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "### åˆ†æ”¯: ${{ inputs.branch_config }} | è½¯ä»¶: ${{ inputs.package_config }} | æ¶æ„: ${{ inputs.target_arch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç›®æ ‡æ–‡ä»¶ | å¤§å° | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "./firmware" ] && [ "$(ls -A ./firmware)" ]; then
            for file in ./firmware/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                filesize=$(stat -c%s "$file" | awk '{printf "%.2f MB", $1/1024/1024}')
                sha256=$(sha256sum "$file" | awk '{print $1}')
                echo "| $filename | $filesize | \`$sha256\` |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "| æœªç”Ÿæˆå›ºä»¶æ–‡ä»¶ | - | - |" >> $GITHUB_STEP_SUMMARY
          fi

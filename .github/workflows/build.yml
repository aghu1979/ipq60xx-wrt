# .github/workflows/build.yml
name: Reusable OpenWrt Build Workflow

# ã€å…³é”®éƒ¨åˆ†ã€‘å£°æ˜Žè¿™æ˜¯ä¸€ä¸ªå¯è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨çš„æ¨¡æ¿
on:
  workflow_call:
    inputs:
      # å®šä¹‰è°ƒç”¨æ—¶éœ€è¦ä¼ å…¥çš„å‚æ•°ï¼Œå°±åƒçƒ¤ç®±ä¸Šçš„æ—‹é’®
      branch_config:
        required: true
        type: string
        description: 'åˆ†æ”¯é…ç½®åï¼Œå¦‚ openwrt_base'
      package_config:
        required: true
        type: string
        description: 'è½¯ä»¶åŒ…é…ç½®åï¼Œå¦‚ Pro'
      target_arch:
        required: true
        type: string
        default: 'ipq60xx'
        description: 'ç›®æ ‡èŠ¯ç‰‡æž¶æž„'
      ubuntu_version:
        description: 'ä½¿ç”¨æœ€ç¨³å®šçš„ ubuntu-22.04ï¼Œå¦‚éœ€è¦ubuntu-24.04æˆ–å…¶å®ƒçŽ¯å¢ƒåœ¨æ­¤ä¿®æ”¹ã€‚'
        required: true
        type: string
        default: 'ubuntu-22.04'

jobs:
  build:
    # ä½¿ç”¨åŠ¨æ€ä¼ å…¥çš„ ubuntu_versionï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç 
    runs-on: ${{ inputs.ubuntu_version }}

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # å°†æˆ‘ä»¬è‡ªå·±ä»“åº“çš„ä»£ç ä¸‹è½½åˆ°è¿è¡ŒçŽ¯å¢ƒä¸­
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ===== ç¼“å­˜ç­–ç•¥å¼€å§‹ =====
      # ç¼“å­˜æ˜¯æå‡æ•ˆçŽ‡çš„å…³é”®ï¼Œå°±åƒæŠŠå¸¸ç”¨çš„é£Ÿææå‰å‡†å¤‡å¥½ï¼Œä¸ç”¨æ¯æ¬¡éƒ½åŽ»è¶…å¸‚é‡‡è´­

      # æ­¥éª¤ 2: ç¼“å­˜ OpenWrt æºç 
      # ä¼˜åŒ–ç‚¹ï¼šé¿å…æ¯æ¬¡éƒ½é‡æ–° git cloneï¼ŒèŠ‚çœæ—¶é—´
      - name: ç¼“å­˜ OpenWrt æºç 
        id: cache-source
        uses: actions/cache@v4
        with:
          path: openwrt
          # ç¼“å­˜é”®ï¼šåŸºäºŽæ“ä½œç³»ç»Ÿã€åˆ†æ”¯é…ç½®å’Œå½“å‰æäº¤çš„å”¯ä¸€ID
          # ç¡®ä¿ä»£ç æœ‰å˜åŠ¨æ—¶ï¼Œç¼“å­˜ä¼šå¤±æ•ˆï¼Œä¿è¯ç¼–è¯‘æ­£ç¡®æ€§
          key: ${{ runner.os }}-${{ inputs.branch_config }}-source-${{ github.sha }}
          # æ¢å¤é”®ï¼šå¦‚æžœä¸Šé¢çš„ç²¾ç¡®ç¼“å­˜æ²¡å‘½ä¸­ï¼Œå°±å°è¯•æ¢å¤åŒåˆ†æ”¯çš„æœ€æ–°ç¼“å­˜
          restore-keys: |
            ${{ runner.os }}-${{ inputs.branch_config }}-source-

      # æ­¥éª¤ 3: å…‹éš†æºç  (å¦‚æžœç¼“å­˜æœªå‘½ä¸­)
      # åªæœ‰å½“æºç ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œæ‰æ‰§è¡Œ git clone
      - name: å…‹éš†æºç 
        if: steps.cache-source.outputs.cache-hit != 'true'
        run: |
          # æ ¹æ®ä¼ å…¥çš„ branch_config åŠ¨æ€é€‰æ‹©ä»“åº“åœ°å€
          if [ "${{ inputs.branch_config }}" == "immwrt_base" ]; then
            REPO_URL="https://github.com/laipeng668/immortalwrt.git"
            REPO_BRANCH="master"
          elif [ "${{ inputs.branch_config }}" == "libwrt_base" ]; then
            REPO_URL="https://github.com/laipeng668/openwrt-6.x.git"
            REPO_BRANCH="k6.12-nss"
          else # é»˜è®¤ä¸º openwrt
            REPO_URL="https://github.com/laipeng668/openwrt.git"
            REPO_BRANCH="master"
          fi
          echo "æ­£åœ¨ä»Ž $REPO_URL (åˆ†æ”¯: $REPO_BRANCH) å…‹éš†æºç åˆ° openwrt/ ç›®å½•"
          git clone $REPO_URL -b $REPO_BRANCH openwrt

      # æ­¥éª¤ 4: ç¼“å­˜ Feeds å’Œä¸‹è½½åŒ…
      # ä¼˜åŒ–ç‚¹ï¼šè¿™æ˜¯æœ€é‡è¦çš„ç¼“å­˜ï¼dl å’Œ feeds ç›®å½•åŒ…å«äº†æ‰€æœ‰è½¯ä»¶åŒ…çš„æºç ï¼Œä¸‹è½½æœ€è€—æ—¶
      - name: ç¼“å­˜ Feeds å’Œä¸‹è½½åŒ…
        id: cache-feeds-dl
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/feeds
          # ç¼“å­˜é”®ï¼šåŸºäºŽæ“ä½œç³»ç»Ÿã€åˆ†æ”¯é…ç½®å’Œæ‰€æœ‰é…ç½®æ–‡ä»¶çš„å†…å®¹å“ˆå¸Œ
          # ä¼˜åŒ–ç‚¹ï¼šå°† branch_config åŠ å…¥é”®ï¼Œå®žçŽ°åˆ†æ”¯çº§ç¼“å­˜éš”ç¦»ï¼
          key: ${{ runner.os }}-${{ inputs.branch_config }}-feeds-dl-${{ hashFiles('openwrt/feeds.conf.default', 'configs/**') }}
          restore-keys: |
            ${{ runner.os }}-${{ inputs.branch_config }}-feeds-dl-
        if: success()

      # æ­¥éª¤ 5: ç¼“å­˜ Ccache (ç¼–è¯‘å™¨ç¼“å­˜)
      # ä¼˜åŒ–ç‚¹ï¼šç¼“å­˜ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¸­é—´æ–‡ä»¶ï¼Œè®©å¢žé‡ç¼–è¯‘é£žå¿«
      - name: Ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          # ç¼“å­˜é”®ï¼šåŸºäºŽç›®æ ‡æž¶æž„å’Œåˆ†æ”¯é…ç½®
          key: ${{ inputs.target_arch }}-${{ inputs.branch_config }}
          # æœ€å¤§ç¼“å­˜å¤§å°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´
          max-size: 5G
      # ===== ç¼“å­˜ç­–ç•¥ç»“æŸ =====

      # æ­¥éª¤ 6: å®‰è£…ç¼–è¯‘ä¾èµ–
      # ä½¿ç”¨ python3-setuptools æ›¿ä»£ python3-distutilsï¼Œä»¥å…¼å®¹ Ubuntu 22.04 å’Œ 24.04
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          echo "::group::Installing System Dependencies on ${{ inputs.ubuntu_version }}"
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext libelf-dev libssl-dev \
          libncurses5-dev libncursesw5-dev python3-pyelftools \
          python3-setuptools rsync swig unzip wget python3-pip ccache
          echo "::endgroup::"

      # æ­¥éª¤ 7: æ›´æ–°å’Œå®‰è£… Feeds
      # åªæœ‰å½“ Feeds ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼Œæ‰æ‰§è¡Œæ›´æ–°
      - name: æ›´æ–°å’Œå®‰è£… Feeds
        if: steps.cache-feeds-dl.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # æ­¥éª¤ 8: åˆå¹¶é…ç½®æ–‡ä»¶
      # å°†æˆ‘ä»¬å®šä¹‰çš„æ¨¡å—åŒ–é…ç½®æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„ .config
      - name: åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          cd openwrt
          echo "ðŸ”§ æ­£åœ¨åˆå¹¶é…ç½®: åˆ†æ”¯-${{ inputs.branch_config }}, è½¯ä»¶-${{ inputs.package_config }}, æž¶æž„-${{ inputs.target_arch }}"
          ./scripts/kconfig/merge_config.sh -m -n \
            ../configs/base/${{ inputs.target_arch }}_base.config \
            ../configs/branch/${{ inputs.branch_config }}.config \
            ../configs/packages/${{ inputs.package_config }}.config
          echo "âœ… é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆã€‚"

      # æ­¥éª¤ 9: è¿è¡Œè‡ªå®šä¹‰DIYè„šæœ¬
      # é›†æˆç‚¹ï¼šåœ¨è¿™é‡Œè°ƒç”¨æˆ‘ä»¬çš„ diy.sh è„šæœ¬ï¼Œè¿›è¡Œä¸ªæ€§åŒ–å®šåˆ¶
      - name: è¿è¡Œè‡ªå®šä¹‰DIYè„šæœ¬
        run: |
          cd openwrt
          chmod +x $GITHUB_WORKSPACE/scripts/diy.sh
          # å°†åˆ†æ”¯å’ŒèŠ¯ç‰‡ä¿¡æ¯ä½œä¸ºå‚æ•°ä¼ ç»™è„šæœ¬
          $GITHUB_WORKSPACE/scripts/diy.sh ${{ inputs.branch_config }} ${{ inputs.target_arch }}

      # æ­¥éª¤ 10: ç¼–è¯‘å›ºä»¶
      # æ­£å¼å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨å¤šæ ¸åŠ é€Ÿ
      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          echo "ðŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          # å¦‚æžœå¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œåˆ™å°è¯•å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘ï¼Œæ–¹ä¾¿æŽ’é”™
          make -j$(nproc) || (echo "âŒ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œæ­£åœ¨å°è¯•å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘..." && make -j1 V=s)

      # æ­¥éª¤ 11: æ”¶é›†å›ºä»¶äº§ç‰©
      # ä»Žç¼–è¯‘è¾“å‡ºç›®å½•ä¸­æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„å›ºä»¶æ–‡ä»¶
      - name: æ”¶é›†å›ºä»¶äº§ç‰©
        run: |
          cd openwrt
          mkdir -p ../firmware
          find bin/targets/ -type f \( -name "*sysupgrade*" -o -name "*factory*" \) -exec cp {} ../firmware/ \;
          echo "âœ… å›ºä»¶äº§ç‰©å·²æ”¶é›†ã€‚"
          ls -lh ../firmware/

      # æ­¥éª¤ 12: ä¸Šä¼ å›ºä»¶äº§ç‰©
      # å°†ç¼–è¯‘å¥½çš„å›ºä»¶ä¸Šä¼ ï¼Œä»¥ä¾¿ä¸‹è½½
      - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          # äº§ç‰©åç§°åŒ…å«æ‰€æœ‰å…³é”®ä¿¡æ¯ï¼Œæ–¹ä¾¿è¯†åˆ«
          name: openwrt-${{ inputs.target_arch }}-${{ inputs.branch_config }}-${{ inputs.package_config }}
          path: ./firmware/

      # æ­¥éª¤ 13: ä¸Šä¼ é”™è¯¯æ—¥å¿— (ä»…åœ¨å¤±è´¥æ—¶)
      # å¦‚æžœç¼–è¯‘å¤±è´¥ï¼ŒæŠŠæ—¥å¿—å’Œé…ç½®æ–‡ä»¶ä¸Šä¼ ï¼Œæ–¹ä¾¿åˆ†æžé—®é¢˜
      - name: ä¸Šä¼ é”™è¯¯æ—¥å¿— (ä»…åœ¨å¤±è´¥æ—¶)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ inputs.branch_config }}-${{ inputs.package_config }}
          path: |
            openwrt/build.log
            openwrt/.config

      # æ­¥éª¤ 14: ç”Ÿæˆæž„å»ºæ‘˜è¦
      # åœ¨ GitHub Actions çš„æ‘˜è¦é¡µé¢ç”Ÿæˆä¸€ä¸ªæ¼‚äº®çš„æŠ¥å‘Š
      - name: ç”Ÿæˆæž„å»ºæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“¦ OpenWrt æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "### åˆ†æ”¯: ${{ inputs.branch_config }} | è½¯ä»¶: ${{ inputs.package_config }} | æž¶æž„: ${{ inputs.target_arch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç›®æ ‡æ–‡ä»¶ | å¤§å° | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "./firmware" ] && [ "$(ls -A ./firmware)" ]; then
            for file in ./firmware/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                filesize=$(stat -c%s "$file" | awk '{printf "%.2f MB", $1/1024/1024}')
                sha256=$(sha256sum "$file" | awk '{print $1}')
                echo "| $filename | $filesize | \`$sha256\` |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "| æœªç”Ÿæˆå›ºä»¶æ–‡ä»¶ | - | - |" >> $GITHUB_STEP_SUMMARY
          fi

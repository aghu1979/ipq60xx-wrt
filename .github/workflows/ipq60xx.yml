name: OpenWrt åˆ†æ­¥å¼å›ºä»¶ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'é€‰æ‹©æºç åˆ†æ”¯'
        required: true
        default: 'immortalwrt'
        type: choice
        options:
        - openwrt
        - immortalwrt
        - libwrt
      arch:
        description: 'é€‰æ‹©èŠ¯ç‰‡æ¶æ„'
        required: true
        default: 'ipq60xx'
        type: choice
        options:
        - ipq60xx
      release:
        description: 'æ˜¯å¦å‘å¸ƒåˆ°Release'
        required: true
        default: 'false'
        type: boolean
      upload_bin:
        description: 'æ˜¯å¦ä¸Šä¼ binç›®å½•'
        required: true
        default: 'false'
        type: boolean

env:
  # åˆ†æ”¯URLæ˜ å°„
  REPO_URL_OPENWRT: "https://github.com/laipeng668/openwrt.git"
  REPO_URL_IMMORTALWRT: "https://github.com/laipeng668/immortalwrt.git"
  REPO_URL_LIBWRT: "https://github.com/laipeng668/openwrt-6.x.git"
  
  # å…¨å±€ç¯å¢ƒå˜é‡
  SOURCE_REPO: ${{ github.event.inputs.branch }}
  DEVICE_TARGET: qualcommax
  DEVICE_SUBTARGET: ${{ github.event.inputs.arch }}
  FIRMWARE_RELEASE: ${{ github.event.inputs.release }}
  UPLOAD_BIN_DIR: ${{ github.event.inputs.upload_bin }}
  FILE_DATE: ${{ format('{0}-{1}', github.event.inputs.branch, github.event.inputs.arch) }}
  DATE: ${{ format('{0}-{1}', github.event.inputs.branch, github.event.inputs.arch) }}
  FIRMWARE_TAG: ${{ format('{0}-{1}', github.event.inputs.branch, github.event.inputs.arch) }}
  OPENWRT_PATH: ${{ github.workspace }}/openwrt
  TEMP_DIR: ${{ github.workspace }}/temp
  LOG_DIR: ${{ github.workspace }}/logs
  PACKAGE_DIR: ${{ github.workspace }}/packages

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šä¸‹è½½æºç ã€é…ç½®åŸºç¡€ç³»ç»Ÿ
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      cache-key-base: ${{ steps.cache-key-base.outputs.key }}
      cache-key-pro: ${{ steps.cache-key-pro.outputs.key }}
      cache-key-max: ${{ steps.cache-key-max.outputs.key }}
      cache-key-ultra: ${{ steps.cache-key-ultra.outputs.key }}
      devices: ${{ steps.get-devices.outputs.devices }}
      kernel-version: ${{ steps.get-kernel.outputs.version }}
      repo-url: ${{ steps.set-env.outputs.repo-url }}
      branch-name: ${{ steps.set-env.outputs.branch-name }}
      branch-abbr: ${{ steps.set-env.outputs.branch-abbr }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        id: set-env
        run: |
          # è®¾ç½®ä»“åº“URLå’Œåˆ†æ”¯
          case "${{ env.SOURCE_REPO }}" in
            "openwrt") 
              REPO_URL="${{ env.REPO_URL_OPENWRT }}"
              BRANCH_NAME="master"
              BRANCH_ABBR="openwrt"
              ;;
            "immortalwrt") 
              REPO_URL="${{ env.REPO_URL_IMMORTALWRT }}"
              BRANCH_NAME="master"
              BRANCH_ABBR="immwrt"
              ;;
            "libwrt") 
              REPO_URL="${{ env.REPO_URL_LIBWRT }}"
              BRANCH_NAME="k6.12-nss"
              BRANCH_ABBR="libwrt"
              ;;
          esac
          
          echo "repo-url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "branch-abbr=$BRANCH_ABBR" >> $GITHUB_OUTPUT
          
          # è®¾ç½®å…¨å±€ç¯å¢ƒå˜é‡
          echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "BRANCH_ABBR=$BRANCH_ABBR" >> $GITHUB_ENV
          echo "VERSION_KERNEL=$(date +%Y.%m)" >> $GITHUB_ENV
          echo "VERSION_INFO=æœ€æ–°æ›´æ–°äº $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          
          echo "ä»“åº“URL: $REPO_URL"
          echo "åˆ†æ”¯åç§°: $BRANCH_NAME"
          echo "åˆ†æ”¯ç¼©å†™: $BRANCH_ABBR"

      - name: ç”Ÿæˆå„é˜¶æ®µç¼“å­˜é”®
        id: cache-key-base
        run: |
          CACHE_KEY="${{ env.SOURCE_REPO }}-${{ env.BRANCH_NAME }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-base-${{ hashFiles('configs/*.config') }}"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "åŸºç¡€ç³»ç»Ÿç¼“å­˜é”®: $CACHE_KEY"
          
      - name: ç”ŸæˆProé…ç½®ç¼“å­˜é”®
        id: cache-key-pro
        run: |
          CACHE_KEY="${{ env.SOURCE_REPO }}-${{ env.BRANCH_NAME }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-pro-${{ hashFiles('configs/*.config') }}"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "Proé…ç½®ç¼“å­˜é”®: $CACHE_KEY"
          
      - name: ç”ŸæˆMaxé…ç½®ç¼“å­˜é”®
        id: cache-key-max
        run: |
          CACHE_KEY="${{ env.SOURCE_REPO }}-${{ env.BRANCH_NAME }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-max-${{ hashFiles('configs/*.config') }}"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "Maxé…ç½®ç¼“å­˜é”®: $CACHE_KEY"
          
      - name: ç”ŸæˆUltraé…ç½®ç¼“å­˜é”®
        id: cache-key-ultra
        run: |
          CACHE_KEY="${{ env.SOURCE_REPO }}-${{ env.BRANCH_NAME }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-ultra-${{ hashFiles('configs/*.config') }}"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "Ultraé…ç½®ç¼“å­˜é”®: $CACHE_KEY"

      - name: æ£€æŸ¥å¹¶æ¢å¤åŸºç¡€ç³»ç»Ÿç¼“å­˜
        id: restore-cache-base
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.OPENWRT_PATH }}
            ${{ env.TEMP_DIR }}
          key: ${{ steps.cache-key-base.outputs.key }}
          restore-keys: |
            ${{ env.SOURCE_REPO }}-${{ env.BRANCH_NAME }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-base-

      - name: æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
        run: |
          if [ "${{ steps.restore-cache-base.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… åŸºç¡€ç³»ç»Ÿç¼“å­˜å‘½ä¸­æˆåŠŸ"
          else
            echo "âŒ åŸºç¡€ç³»ç»Ÿç¼“å­˜æœªå‘½ä¸­ï¼Œå°†è¿›è¡Œå®Œæ•´ç¼–è¯‘"
          fi

      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p ${{ env.OPENWRT_PATH }}
          mkdir -p ${{ env.TEMP_DIR }}
          mkdir -p ${{ env.LOG_DIR }}
          mkdir -p ${{ env.PACKAGE_DIR }}

      - name: ä¸‹è½½æºç 
        if: steps.restore-cache-base.outputs.cache-hit != 'true'
        run: |
          echo "ğŸš€ å¼€å§‹ä¸‹è½½æºç ..."
          git clone ${{ env.REPO_URL }} ${{ env.OPENWRT_PATH }}
          cd ${{ env.OPENWRT_PATH }}
          git checkout ${{ env.BRANCH_NAME }}
          echo "âœ… æºç ä¸‹è½½å®Œæˆ"

      - name: åˆå¹¶åŸºç¡€é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ”§ å¼€å§‹åˆå¹¶åŸºç¡€é…ç½®æ–‡ä»¶..."
          
          # åˆå¹¶åŸºç¡€é…ç½®æ–‡ä»¶ï¼ˆä¸åŒ…å«Pro/Max/Ultraï¼‰
          cat configs/${{ env.DEVICE_SUBTARGET }}_base.config > ${{ env.OPENWRT_PATH }}/.config
          cat configs/${{ env.BRANCH_ABBR }}.config >> ${{ env.OPENWRT_PATH }}/.config
          
          echo "âœ… åŸºç¡€é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆ"
          echo "é…ç½®æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -20 ${{ env.OPENWRT_PATH }}/.config

      - name: è·å–è®¾å¤‡åˆ—è¡¨
        id: get-devices
        run: |
          echo "ğŸ“‹ è·å–è®¾å¤‡åˆ—è¡¨..."
          DEVICES=$(grep -oE 'CONFIG_TARGET_DEVICE_.*_DEVICE_[^=]+=y' ${{ env.OPENWRT_PATH }}/.config | sed -E 's/.*DEVICE_([^=]+)=y/\1/' | tr '\n' ' ')
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°çš„è®¾å¤‡: $DEVICES"

      - name: è·å–å†…æ ¸ç‰ˆæœ¬
        id: get-kernel
        run: |
          echo "ğŸ” è·å–å†…æ ¸ç‰ˆæœ¬..."
          VERSION=$(grep 'CONFIG_KERNEL_' ${{ env.OPENWRT_PATH }}/.config | head -1 | cut -d'=' -f2 | tr -d '"')
          if [ -z "$VERSION" ]; then
            VERSION="6.12"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "å†…æ ¸ç‰ˆæœ¬: $VERSION"

      - name: è¿è¡ŒDIYè„šæœ¬
        run: |
          echo "ğŸ› ï¸ è¿è¡ŒDIYè„šæœ¬..."
          chmod +x scripts/diy.sh
          ./scripts/diy.sh ${{ env.OPENWRT_PATH }}
          echo "âœ… DIYè„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: æ›´æ–° feeds
        if: steps.restore-cache-base.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ”„ æ›´æ–° feeds..."
          cd ${{ env.OPENWRT_PATH }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "âœ… Feeds æ›´æ–°å®Œæˆ"

      - name: ä¿å­˜åŸºç¡€ç³»ç»Ÿç¼“å­˜
        if: steps.restore-cache-base.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.OPENWRT_PATH }}
            ${{ env.TEMP_DIR }}
          key: ${{ steps.cache-key-base.outputs.key }}

  # åŸºç¡€ç³»ç»Ÿç¼–è¯‘é˜¶æ®µ
  build-base:
    needs: prepare
    runs-on: ubuntu-22.04
    outputs:
      build-status: ${{ steps.compile.outputs.status }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_URL=${{ needs.prepare.outputs.repo-url }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ needs.prepare.outputs.branch-name }}" >> $GITHUB_ENV
          echo "BRANCH_ABBR=${{ needs.prepare.outputs.branch-abbr }}" >> $GITHUB_ENV
          echo "VERSION_KERNEL=${{ needs.prepare.outputs.kernel-version }}" >> $GITHUB_ENV
          echo "VERSION_INFO=æœ€æ–°æ›´æ–°äº $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: æ¢å¤åŸºç¡€ç³»ç»Ÿç¼“å­˜
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.OPENWRT_PATH }}
            ${{ env.TEMP_DIR }}
          key: ${{ needs.prepare.outputs.cache-key-base }}

      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p ${{ env.LOG_DIR }}
          mkdir -p ${{ env.PACKAGE_DIR }}

      - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        run: |
          echo "âš™ï¸ è®¾ç½®åŸºç¡€ç³»ç»Ÿç¼–è¯‘ç¯å¢ƒ..."
          cd ${{ env.OPENWRT_PATH }}
          
          # è®¾ç½®å…¶ä»–é…ç½®
          echo "CONFIG_USE_APK=n" >> .config
          
          # ç”Ÿæˆé…ç½®
          make defconfig
          echo "âœ… åŸºç¡€ç³»ç»Ÿç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

      - name: ä¸‹è½½ä¾èµ–
        run: |
          echo "ğŸ“¥ ä¸‹è½½ä¾èµ–..."
          cd ${{ env.OPENWRT_PATH }}
          make download -j$(nproc)
          echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

      - name: ç¼–è¯‘åŸºç¡€ç³»ç»Ÿ
        id: compile
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘åŸºç¡€ç³»ç»Ÿ..."
          cd ${{ env.OPENWRT_PATH }}
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ åŸºç¡€ç³»ç»Ÿç¼–è¯‘å¤±è´¥ï¼Œè®°å½•é”™è¯¯æ—¥å¿—..."; tail -1000 build_log.txt > ${{ env.LOG_DIR }}/base_error.log; exit 1' ERR
          
          # å¼€å§‹ç¼–è¯‘å¹¶è®°å½•æ—¥å¿—
          make -j$(nproc) 2>&1 | tee build_log.txt
          
          echo "âœ… åŸºç¡€ç³»ç»Ÿç¼–è¯‘å®Œæˆ"
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¿å­˜åŸºç¡€ç³»ç»Ÿç¼–è¯‘ç»“æœ
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.OPENWRT_PATH }}
            ${{ env.TEMP_DIR }}
          key: ${{ needs.prepare.outputs.cache-key-base }}

  # Proé…ç½®ç¼–è¯‘é˜¶æ®µ
  build-pro:
    needs: [prepare, build-base]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        device: ${{ fromJson(needs.prepare.outputs.devices) }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_URL=${{ needs.prepare.outputs.repo-url }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ needs.prepare.outputs.branch-name }}" >> $GITHUB_ENV
          echo "BRANCH_ABBR=${{ needs.prepare.outputs.branch-abbr }}" >> $GITHUB_ENV
          echo "VERSION_KERNEL=${{ needs.prepare.outputs.kernel-version }}" >> $GITHUB_ENV
          echo "VERSION_INFO=æœ€æ–°æ›´æ–°äº $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "CONFIG_TYPE=Pro" >> $GITHUB_ENV

      - name: æ£€æŸ¥åŸºç¡€ç³»ç»Ÿç¼–è¯‘çŠ¶æ€
        run: |
          if [ "${{ needs.build-base.outputs.build-status }}" != "success" ]; then
            echo "âŒ åŸºç¡€ç³»ç»Ÿç¼–è¯‘å¤±è´¥ï¼Œè·³è¿‡Proé…ç½®ç¼–è¯‘"
            exit 1
          fi

      - name: æ¢å¤åŸºç¡€ç³»ç»Ÿç¼“å­˜
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.OPENWRT_PATH }}
            ${{ env.TEMP_DIR }}
          key: ${{ needs.prepare.outputs.cache-key-base }}

      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p ${{ env.LOG_DIR }}
          mkdir -p ${{ env.PACKAGE_DIR }}

      - name: åˆå¹¶Proé…ç½®
        run: |
          echo "ğŸ”§ åˆå¹¶Proé…ç½®..."
          cd ${{ env.OPENWRT_PATH }}
          
          # åˆå¹¶Proé…ç½®
          cat configs/Pro.config >> .config
          
          # ç”Ÿæˆé…ç½®
          make defconfig
          echo "âœ… Proé…ç½®åˆå¹¶å®Œæˆ"

      - name: ç¼–è¯‘Proé…ç½®å›ºä»¶
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘Proé…ç½®å›ºä»¶: ${{ matrix.device }}..."
          cd ${{ env.OPENWRT_PATH }}
          
          # è®¾ç½®è®¾å¤‡é…ç½®
          sed -i "s/CONFIG_TARGET_DEVICE_.*_DEVICE_.*/CONFIG_TARGET_DEVICE_${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}_DEVICE_${{ matrix.device }}=y/" .config
          
          # ç”Ÿæˆé…ç½®
          make defconfig
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ Proé…ç½®ç¼–è¯‘å¤±è´¥ï¼Œè®°å½•é”™è¯¯æ—¥å¿—..."; tail -1000 build_log.txt > ${{ env.LOG_DIR }}/${{ matrix.device }}_pro_error.log; exit 1' ERR
          
          # å¼€å§‹ç¼–è¯‘å¹¶è®°å½•æ—¥å¿—
          make -j$(nproc) 2>&1 | tee build_log.txt
          
          echo "âœ… Proé…ç½®å›ºä»¶ç¼–è¯‘å®Œæˆ: ${{ matrix.device }}"

      - name: æ•´ç†Proé…ç½®äº§å‡ºç‰©
        run: |
          echo "ğŸ“¦ æ•´ç†Proé…ç½®äº§å‡ºç‰©..."
          cd ${{ env.OPENWRT_PATH }}
          
          # åˆ›å»ºè®¾å¤‡ä¸´æ—¶ç›®å½•
          DEVICE_TEMP_DIR="${{ env.TEMP_DIR }}/pro/${{ matrix.device }}"
          mkdir -p $DEVICE_TEMP_DIR
          
          # å¤åˆ¶å¹¶é‡å‘½åå›ºä»¶
          for file in bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/*${{ env.DEVICE_SUBTARGET }}*${{ matrix.device }}*squashfs-*.bin; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [[ "$filename" =~ "factory.bin" ]]; then
                new_name="${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-factory-Pro.bin"
              elif [[ "$filename" =~ "sysupgrade.bin" ]]; then
                new_name="${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-sysupgrade-Pro.bin"
              fi
              cp "$file" "$DEVICE_TEMP_DIR/$new_name"
              echo "Proå›ºä»¶é‡å‘½å: $filename -> $new_name"
            fi
          done
          
          # å¤åˆ¶å¹¶é‡å‘½åé…ç½®æ–‡ä»¶
          if [ -f ".config" ]; then
            cp .config "$DEVICE_TEMP_DIR/${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Pro.config"
          fi
          
          # å¤åˆ¶å¹¶é‡å‘½åæ¸…å•æ–‡ä»¶
          if [ -f "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/${{ env.SOURCE_REPO }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}.manifest" ]; then
            cp "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/${{ env.SOURCE_REPO }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}.manifest" \
               "$DEVICE_TEMP_DIR/${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Pro.manifest"
          fi
          
          # å¤åˆ¶å¹¶é‡å‘½åæ„å»ºä¿¡æ¯
          if [ -f "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/config.buildinfo" ]; then
            cp "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/config.buildinfo" \
               "$DEVICE_TEMP_DIR/${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Pro.config.buildinfo"
          fi
          
          # å¤åˆ¶æ—¥å¿—
          if [ -f "build_log.txt" ]; then
            cp build_log.txt "$DEVICE_TEMP_DIR/${{ matrix.device }}_pro_build.log"
          fi
          
          echo "âœ… Proé…ç½®äº§å‡ºç‰©æ•´ç†å®Œæˆ: ${{ matrix.device }}"

      - name: ä¸Šä¼ Proé…ç½®äº§å‡ºç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SOURCE_REPO }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Pro
          path: ${{ env.TEMP_DIR }}/pro/${{ matrix.device }}
          retention-days: 7

  # Maxé…ç½®ç¼–è¯‘é˜¶æ®µ
  build-max:
    needs: [prepare, build-base]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        device: ${{ fromJson(needs.prepare.outputs.devices) }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_URL=${{ needs.prepare.outputs.repo-url }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ needs.prepare.outputs.branch-name }}" >> $GITHUB_ENV
          echo "BRANCH_ABBR=${{ needs.prepare.outputs.branch-abbr }}" >> $GITHUB_ENV
          echo "VERSION_KERNEL=${{ needs.prepare.outputs.kernel-version }}" >> $GITHUB_ENV
          echo "VERSION_INFO=æœ€æ–°æ›´æ–°äº $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "CONFIG_TYPE=Max" >> $GITHUB_ENV

      - name: æ£€æŸ¥åŸºç¡€ç³»ç»Ÿç¼–è¯‘çŠ¶æ€
        run: |
          if [ "${{ needs.build-base.outputs.build-status }}" != "success" ]; then
            echo "âŒ åŸºç¡€ç³»ç»Ÿç¼–è¯‘å¤±è´¥ï¼Œè·³è¿‡Maxé…ç½®ç¼–è¯‘"
            exit 1
          fi

      - name: æ¢å¤åŸºç¡€ç³»ç»Ÿç¼“å­˜
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.OPENWRT_PATH }}
            ${{ env.TEMP_DIR }}
          key: ${{ needs.prepare.outputs.cache-key-base }}

      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p ${{ env.LOG_DIR }}
          mkdir -p ${{ env.PACKAGE_DIR }}

      - name: åˆå¹¶Maxé…ç½®
        run: |
          echo "ğŸ”§ åˆå¹¶Maxé…ç½®..."
          cd ${{ env.OPENWRT_PATH }}
          
          # åˆå¹¶Maxé…ç½®
          cat configs/Max.config >> .config
          
          # ç”Ÿæˆé…ç½®
          make defconfig
          echo "âœ… Maxé…ç½®åˆå¹¶å®Œæˆ"

      - name: ç¼–è¯‘Maxé…ç½®å›ºä»¶
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘Maxé…ç½®å›ºä»¶: ${{ matrix.device }}..."
          cd ${{ env.OPENWRT_PATH }}
          
          # è®¾ç½®è®¾å¤‡é…ç½®
          sed -i "s/CONFIG_TARGET_DEVICE_.*_DEVICE_.*/CONFIG_TARGET_DEVICE_${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}_DEVICE_${{ matrix.device }}=y/" .config
          
          # ç”Ÿæˆé…ç½®
          make defconfig
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ Maxé…ç½®ç¼–è¯‘å¤±è´¥ï¼Œè®°å½•é”™è¯¯æ—¥å¿—..."; tail -1000 build_log.txt > ${{ env.LOG_DIR }}/${{ matrix.device }}_max_error.log; exit 1' ERR
          
          # å¼€å§‹ç¼–è¯‘å¹¶è®°å½•æ—¥å¿—
          make -j$(nproc) 2>&1 | tee build_log.txt
          
          echo "âœ… Maxé…ç½®å›ºä»¶ç¼–è¯‘å®Œæˆ: ${{ matrix.device }}"

      - name: æ•´ç†Maxé…ç½®äº§å‡ºç‰©
        run: |
          echo "ğŸ“¦ æ•´ç†Maxé…ç½®äº§å‡ºç‰©..."
          cd ${{ env.OPENWRT_PATH }}
          
          # åˆ›å»ºè®¾å¤‡ä¸´æ—¶ç›®å½•
          DEVICE_TEMP_DIR="${{ env.TEMP_DIR }}/max/${{ matrix.device }}"
          mkdir -p $DEVICE_TEMP_DIR
          
          # å¤åˆ¶å¹¶é‡å‘½åå›ºä»¶
          for file in bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/*${{ env.DEVICE_SUBTARGET }}*${{ matrix.device }}*squashfs-*.bin; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [[ "$filename" =~ "factory.bin" ]]; then
                new_name="${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-factory-Max.bin"
              elif [[ "$filename" =~ "sysupgrade.bin" ]]; then
                new_name="${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-sysupgrade-Max.bin"
              fi
              cp "$file" "$DEVICE_TEMP_DIR/$new_name"
              echo "Maxå›ºä»¶é‡å‘½å: $filename -> $new_name"
            fi
          done
          
          # å¤åˆ¶å¹¶é‡å‘½åé…ç½®æ–‡ä»¶
          if [ -f ".config" ]; then
            cp .config "$DEVICE_TEMP_DIR/${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Max.config"
          fi
          
          # å¤åˆ¶å¹¶é‡å‘½åæ¸…å•æ–‡ä»¶
          if [ -f "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/${{ env.SOURCE_REPO }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}.manifest" ]; then
            cp "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/${{ env.SOURCE_REPO }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}.manifest" \
               "$DEVICE_TEMP_DIR/${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Max.manifest"
          fi
          
          # å¤åˆ¶å¹¶é‡å‘½åæ„å»ºä¿¡æ¯
          if [ -f "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/config.buildinfo" ]; then
            cp "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/config.buildinfo" \
               "$DEVICE_TEMP_DIR/${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Max.config.buildinfo"
          fi
          
          # å¤åˆ¶æ—¥å¿—
          if [ -f "build_log.txt" ]; then
            cp build_log.txt "$DEVICE_TEMP_DIR/${{ matrix.device }}_max_build.log"
          fi
          
          echo "âœ… Maxé…ç½®äº§å‡ºç‰©æ•´ç†å®Œæˆ: ${{ matrix.device }}"

      - name: ä¸Šä¼ Maxé…ç½®äº§å‡ºç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SOURCE_REPO }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Max
          path: ${{ env.TEMP_DIR }}/max/${{ matrix.device }}
          retention-days: 7

  # Ultraé…ç½®ç¼–è¯‘é˜¶æ®µ
  build-ultra:
    needs: [prepare, build-base]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        device: ${{ fromJson(needs.prepare.outputs.devices) }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_URL=${{ needs.prepare.outputs.repo-url }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ needs.prepare.outputs.branch-name }}" >> $GITHUB_ENV
          echo "BRANCH_ABBR=${{ needs.prepare.outputs.branch-abbr }}" >> $GITHUB_ENV
          echo "VERSION_KERNEL=${{ needs.prepare.outputs.kernel-version }}" >> $GITHUB_ENV
          echo "VERSION_INFO=æœ€æ–°æ›´æ–°äº $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "CONFIG_TYPE=Ultra" >> $GITHUB_ENV

      - name: æ£€æŸ¥åŸºç¡€ç³»ç»Ÿç¼–è¯‘çŠ¶æ€
        run: |
          if [ "${{ needs.build-base.outputs.build-status }}" != "success" ]; then
            echo "âŒ åŸºç¡€ç³»ç»Ÿç¼–è¯‘å¤±è´¥ï¼Œè·³è¿‡Ultraé…ç½®ç¼–è¯‘"
            exit 1
          fi

      - name: æ¢å¤åŸºç¡€ç³»ç»Ÿç¼“å­˜
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.OPENWRT_PATH }}
            ${{ env.TEMP_DIR }}
          key: ${{ needs.prepare.outputs.cache-key-base }}

      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p ${{ env.LOG_DIR }}
          mkdir -p ${{ env.PACKAGE_DIR }}

      - name: åˆå¹¶Ultraé…ç½®
        run: |
          echo "ğŸ”§ åˆå¹¶Ultraé…ç½®..."
          cd ${{ env.OPENWRT_PATH }}
          
          # åˆå¹¶Ultraé…ç½®
          cat configs/Ultra.config >> .config
          
          # ç”Ÿæˆé…ç½®
          make defconfig
          echo "âœ… Ultraé…ç½®åˆå¹¶å®Œæˆ"

      - name: ç¼–è¯‘Ultraé…ç½®å›ºä»¶
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘Ultraé…ç½®å›ºä»¶: ${{ matrix.device }}..."
          cd ${{ env.OPENWRT_PATH }}
          
          # è®¾ç½®è®¾å¤‡é…ç½®
          sed -i "s/CONFIG_TARGET_DEVICE_.*_DEVICE_.*/CONFIG_TARGET_DEVICE_${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}_DEVICE_${{ matrix.device }}=y/" .config
          
          # ç”Ÿæˆé…ç½®
          make defconfig
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ Ultraé…ç½®ç¼–è¯‘å¤±è´¥ï¼Œè®°å½•é”™è¯¯æ—¥å¿—..."; tail -1000 build_log.txt > ${{ env.LOG_DIR }}/${{ matrix.device }}_ultra_error.log; exit 1' ERR
          
          # å¼€å§‹ç¼–è¯‘å¹¶è®°å½•æ—¥å¿—
          make -j$(nproc) 2>&1 | tee build_log.txt
          
          echo "âœ… Ultraé…ç½®å›ºä»¶ç¼–è¯‘å®Œæˆ: ${{ matrix.device }}"

      - name: æ•´ç†Ultraé…ç½®äº§å‡ºç‰©
        run: |
          echo "ğŸ“¦ æ•´ç†Ultraé…ç½®äº§å‡ºç‰©..."
          cd ${{ env.OPENWRT_PATH }}
          
          # åˆ›å»ºè®¾å¤‡ä¸´æ—¶ç›®å½•
          DEVICE_TEMP_DIR="${{ env.TEMP_DIR }}/ultra/${{ matrix.device }}"
          mkdir -p $DEVICE_TEMP_DIR
          
          # å¤åˆ¶å¹¶é‡å‘½åå›ºä»¶
          for file in bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/*${{ env.DEVICE_SUBTARGET }}*${{ matrix.device }}*squashfs-*.bin; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [[ "$filename" =~ "factory.bin" ]]; then
                new_name="${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-factory-Ultra.bin"
              elif [[ "$filename" =~ "sysupgrade.bin" ]]; then
                new_name="${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-sysupgrade-Ultra.bin"
              fi
              cp "$file" "$DEVICE_TEMP_DIR/$new_name"
              echo "Ultraå›ºä»¶é‡å‘½å: $filename -> $new_name"
            fi
          done
          
          # å¤åˆ¶å¹¶é‡å‘½åé…ç½®æ–‡ä»¶
          if [ -f ".config" ]; then
            cp .config "$DEVICE_TEMP_DIR/${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Ultra.config"
          fi
          
          # å¤åˆ¶å¹¶é‡å‘½åæ¸…å•æ–‡ä»¶
          if [ -f "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/${{ env.SOURCE_REPO }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}.manifest" ]; then
            cp "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/${{ env.SOURCE_REPO }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}.manifest" \
               "$DEVICE_TEMP_DIR/${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Ultra.manifest"
          fi
          
          # å¤åˆ¶å¹¶é‡å‘½åæ„å»ºä¿¡æ¯
          if [ -f "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/config.buildinfo" ]; then
            cp "bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}/config.buildinfo" \
               "$DEVICE_TEMP_DIR/${{ env.BRANCH_ABBR }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Ultra.config.buildinfo"
          fi
          
          # å¤åˆ¶æ—¥å¿—
          if [ -f "build_log.txt" ]; then
            cp build_log.txt "$DEVICE_TEMP_DIR/${{ matrix.device }}_ultra_build.log"
          fi
          
          echo "âœ… Ultraé…ç½®äº§å‡ºç‰©æ•´ç†å®Œæˆ: ${{ matrix.device }}"

      - name: ä¸Šä¼ Ultraé…ç½®äº§å‡ºç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SOURCE_REPO }}-${{ env.DEVICE_SUBTARGET }}-${{ matrix.device }}-Ultra
          path: ${{ env.TEMP_DIR }}/ultra/${{ matrix.device }}
          retention-days: 7

  # æ±‡æ€»é˜¶æ®µï¼šæ•´ç†æ‰€æœ‰äº§å‡ºç‰©å¹¶å‘å¸ƒ
  publish:
    needs: [prepare, build-base, build-pro, build-max, build-ultra]
    runs-on: ubuntu-22.04
    if: github.event.inputs.release == 'true'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_URL=${{ needs.prepare.outputs.repo-url }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ needs.prepare.outputs.branch-name }}" >> $GITHUB_ENV
          echo "BRANCH_ABBR=${{ needs.prepare.outputs.branch-abbr }}" >> $GITHUB_ENV
          echo "VERSION_KERNEL=${{ needs.prepare.outputs.kernel-version }}" >> $GITHUB_ENV
          echo "VERSION_INFO=æœ€æ–°æ›´æ–°äº $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p ${{ env.TEMP_DIR }}
          mkdir -p ${{ env.LOG_DIR }}
          mkdir -p ${{ env.PACKAGE_DIR }}

      - name: ä¸‹è½½æ‰€æœ‰äº§å‡ºç‰©
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.TEMP_DIR }}/artifacts

      - name: æ•´ç†äº§å‡ºç‰©
        run: |
          echo "ğŸ“¦ æ•´ç†æ‰€æœ‰äº§å‡ºç‰©..."
          
          # åˆ›å»ºæœ€ç»ˆç›®å½•ç»“æ„
          FINAL_DIR="${{ env.TEMP_DIR }}/final"
          mkdir -p $FINAL_DIR
          
          # åˆå¹¶æ‰€æœ‰è®¾å¤‡äº§å‡ºç‰©
          for config_type in pro max ultra; do
            for device_dir in ${{ env.TEMP_DIR }}/artifacts/*${config_type}/*; do
              if [ -d "$device_dir" ]; then
                echo "å¤„ç†é…ç½®: $config_type, è®¾å¤‡: $(basename $device_dir)"
                
                # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°æœ€ç»ˆç›®å½•
                cp -r "$device_dir"/* "$FINAL_DIR/"
              fi
            done
          done
          
          # æ‰“åŒ…é…ç½®æ–‡ä»¶
          cd $FINAL_DIR
          tar -zcf ${{ env.DEVICE_SUBTARGET }}-config.tar.gz *.config
          
          # æ‰“åŒ…æ—¥å¿—æ–‡ä»¶
          tar -zcf ${{ env.DEVICE_SUBTARGET }}-log.tar.gz *_build.log *_error.log 2>/dev/null || true
          
          # åˆ›å»ºè½¯ä»¶åŒ…åˆ—è¡¨
          ls -la > ${{ env.TEMP_DIR }}/final/package_list.txt
          
          echo "âœ… äº§å‡ºç‰©æ•´ç†å®Œæˆ"

      - name: ç”ŸæˆReleaseè¯´æ˜
        run: |
          echo "ğŸ“ ç”ŸæˆReleaseè¯´æ˜..."
          
          # åˆ›å»ºReleaseè¯´æ˜
          cat > ${{ env.TEMP_DIR }}/release_notes.md << EOF
          # ${{ env.SOURCE_REPO }} å›ºä»¶å‘å¸ƒ
          
          ## ğŸ“’ å›ºä»¶ä¿¡æ¯
          - è¿™æ˜¯åˆ†æ­¥å¼ç¼–è¯‘çš„å›ºä»¶ï¼ŒåŒ…å«Proã€Maxã€Ultraä¸‰ç§é…ç½®
          - ğŸ’» è¿™æ˜¯ ${{ env.DEVICE_SUBTARGET }} å¹³å°ä½¿ç”¨çš„ ${{ env.SOURCE_REPO }} å›ºä»¶
          - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
          - ğŸ’ æºç åˆ†æ”¯: ${{ env.BRANCH_NAME }}
          - ğŸŒ é»˜è®¤åœ°å€: **192.168.111.1**
          - ğŸ”‘ é»˜è®¤å¯†ç : none
          - ğŸ“¶ é»˜è®¤WIFIå¯†ç : 12345678
          
          ## ğŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶å†…æ ¸ç‰ˆæœ¬ï¼š**${{ env.VERSION_KERNEL }}**
          - å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
          - ${{ env.VERSION_INFO }}
          
          ## ğŸ“¦ åŒ…å«çš„è®¾å¤‡
          ${{ needs.prepare.outputs.devices }}
          
          ## ğŸ“‹ åŒ…å«çš„è½¯ä»¶åŒ…
          \`\`\`
          $(cat ${{ env.TEMP_DIR }}/final/package_list.txt)
          \`\`\`
          
          ## ğŸ“¥ ä¸‹è½½è¯´æ˜
          - å›ºä»¶æ–‡ä»¶å‘½åè§„åˆ™: ${{ env.BRANCH_ABBR }}-èŠ¯ç‰‡-è®¾å¤‡-ç±»å‹-é…ç½®.bin
          - ä¾‹å¦‚: ${{ env.BRANCH_ABBR }}-ipq60xx-jdcloud_re-ss-01-sysupgrade-Pro.bin
          
          ---
          ä½œè€…: Mary
          å‘å¸ƒæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          EOF
          
          echo "âœ… Releaseè¯´æ˜ç”Ÿæˆå®Œæˆ"

      - name: å‘å¸ƒåˆ°Release
        uses: ncipollo/release-action@v1
        with:
          name: ${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.TEMP_DIR }}/final/*
          bodyFile: ${{ env.TEMP_DIR }}/release_notes.md

  # æ¸…ç†é˜¶æ®µï¼šåˆ é™¤æ—§ç¼“å­˜
  cleanup:
    needs: [prepare, build-base, build-pro, build-max, build-ultra, publish]
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: åˆ é™¤æ—§ç¼“å­˜
        run: |
          echo "ğŸ—‘ï¸ åˆ é™¤æ—§ç¼“å­˜..."
          
          # è·å–ç¼“å­˜åˆ—è¡¨å¹¶åˆ é™¤
          gh cache list --key ${{ env.SOURCE_REPO }}-${{ env.BRANCH_NAME }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}- --json key --jq '.[] | .key' | while read -r key; do
            gh cache delete "$key"
          done
          
          # è¾“å‡ºç¼“å­˜çŠ¶æ€
          echo "========ç¼“å­˜çŠ¶æ€========"
          echo "ccache: $(du -sh ${{ env.OPENWRT_PATH }}/.ccache 2>/dev/null | cut -f 1 || echo 'N/A')"
          echo "staging: $(du -sh ${{ env.OPENWRT_PATH }}/staging_dir 2>/dev/null | cut -f 1 || echo 'N/A')"
          echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
